<!-- TraceabilityJourney.html (FULL ‚Ä¢ paste entire file) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ crop_id }} ¬∑ Traceability Journey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <link rel="stylesheet" href="{{ url_for('static', filename='traceabilityjourney.css') }}">
</head>

<body>

{# -----------------------------
   Crop Name
------------------------------ #}
{% set crop_raw = (events_combined[0].cropType if events_combined and events_combined|length > 0 else 'Rice') %}

{% set crop_slug = crop_raw|lower|trim
    |replace(' ', '_')
    |replace('/', '_')
    |replace('&', 'and')
%}

{# ------------------------------------------------
   FORCE ASSET DIRECTORY (no empty allowed)
------------------------------------------------ #}
{% if crop_slug in ['rice', 'assam_red_rice'] %}
    {% set asset_dir = 'rice' %}
{% elif crop_slug == 'wheat' %}
    {% set asset_dir = 'wheat' %}
{% elif crop_slug == 'turmeric' %}
    {% set asset_dir = 'turmeric' %}
{% else %}
    {% set asset_dir = 'rice' %}  {# default fallback ALWAYS #}
{% endif %}

{# -----------------------------
   Final Image Paths
------------------------------ #}
{% set hero_img    = url_for('static', filename='images/crops/' ~ asset_dir ~ '/' ~ asset_dir ~ '_banner.webp') %}
{% set product_img = url_for('static', filename='images/crops/' ~ asset_dir ~ '/' ~ asset_dir ~ '_product.jpg') %}
{% set base_dir    = '/static/images/crops/' ~ asset_dir %}
{% set placeholder = url_for('static', filename='images/crops/common/planted.jpg') %}

<!-- HERO -->
<section class="hero" id="hero">
  <picture class="hero-media">
    <source srcset="{{ hero_webp }}" type="image/webp">
    <img class="hero-bg"
         src="{{ hero_img }}"
         alt="{{ crop_raw }} banner"
         loading="eager"
         onerror="this.onerror=null;this.src='{{ placeholder }}'">
  </picture>

  <!-- overlays for readability + premium look (no ugly blur box) -->
  <div class="hero-overlay" aria-hidden="true"></div>
  <div class="hero-bottomfade" aria-hidden="true"></div>

  <div class="shell hero-inner">
    <!-- Professional glass info card (dark text since banner is light) -->

  </div>
</section>

<main class="shell body">
  <div class="grid">

    <!-- LEFT: Timeline -->
    <section class="panel timeline-panel">
      <div class="panel-head">
        <div class="panel-head-left">
          <div class="panel-title">Traceability Timeline</div>
          <div class="panel-subtitle">A clean visual story of verified events</div>
        </div>
        <div class="panel-pill">
          <span class="panel-pill-dot"></span>
          <span>{{ (events_combined|length) if events_combined else 0 }} events</span>
        </div>
      </div>

      <div class="timeline">
        <div class="rail">
          {% if events_combined %}
            {% for e in events_combined %}
              {% set key = (e.image_stage or e.status or 'event')|lower %}
              {% set stage = (e.stage or '')|lower %}

              {% set stage_file =
                'planted.jpg' if key == 'planted' else
                'harvested.jpg' if key == 'harvested' else
                'processed_received.jpg' if (key == 'processed' and stage == 'received') or (key == 'processed_received') else
                'processed_processed.jpg' if (key == 'processed' and stage != 'received') or (key == 'processed_processed') else
                'distributed_received.jpg' if (key == 'distributed' and stage == 'received') or (key == 'distributed_received') else
                'distributed_dispatched.jpg' if (key == 'distributed' and stage != 'received') or (key == 'distributed_dispatched') else
                'retail_received.jpg' if (key == 'retail' and stage == 'received') or (key == 'retail_received') else
                'retail_sold.jpg' if (key == 'retail' and stage != 'received') or (key == 'retail_sold') else
                (crop_dir ~ '_product.jpg')
              %}

              {% set thumb_url = base_dir ~ '/' ~ stage_file %}
              {% set common_fallback =
                common_dir ~ '/' ~ (
                  'harvested.jpg' if stage_file == 'harvested.jpg' else
                  'planted.jpg'
                )
              %}

              <article class="event" data-kind="{{ key }}" data-stage="{{ stage }}">
                <!-- neat header strip -->
                <div class="event-strip">
                  <div class="event-strip-left">
                    <span class="event-strip-icon" aria-hidden="true">üîó</span>
                    <div class="event-strip-titles">
                      <div class="event-strip-title">
                        {{ e.status }}{% if e.stage %} <span class="sep">‚Ä¢</span> {{ e.stage }}{% endif %}
                      </div>
                      <div class="event-strip-sub">
                        <span class="proof">Verified</span>
                        <span class="dotsep">‚Ä¢</span>
                        <span class="small">{{ e.timestamp or '‚Äî' }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="event-body">
                  <div class="thumb">
                    <img
                      src="{{ thumb_url }}"
                      alt="{{ e.status }} {{ e.stage or '' }}"
                      loading="lazy"
                      onerror="this.onerror=null; this.src='{{ common_fallback }}'; this.onerror=function(){ this.src='{{ placeholder }}'; };">
                    <div class="byline">By ‚Äì {{ e.actor or '‚Äî' }}</div>
                  </div>

                  <div class="details">
                    <div class="kv"><div class="k">Location</div><div class="v">{{ e.location or '‚Äî' }}</div></div>
                    <div class="kv"><div class="k">Crop</div><div class="v">{{ e.cropType or '‚Äî' }}</div></div>

                    {% if e.batchCode %}
                      <div class="kv"><div class="k">Batch</div><div class="v">{{ e.batchCode }}</div></div>
                    {% endif %}

                    {% if e.status == 'Planted' %}
                      <div class="kv"><div class="k">Date Planted</div><div class="v">{{ e.datePlanted or '‚Äî' }}</div></div>
                      <div class="kv"><div class="k">Area Size</div><div class="v">{{ e.areaSize or '‚Äî' }}</div></div>

                    {% elif e.status == 'Harvested' %}
                      <div class="kv"><div class="k">Harvest Date</div><div class="v">{{ e.harvestDate or '‚Äî' }}</div></div>
                      <div class="kv"><div class="k">Quantity</div><div class="v">{{ e.harvestQuantity or '‚Äî' }}</div></div>
                      <div class="kv"><div class="k">Packaging</div><div class="v">{{ e.packagingType or '‚Äî' }}</div></div>

                    {% elif e.status == 'Processed' %}
                      {% if (e.stage or '') == 'Received' %}
                        <div class="kv"><div class="k">Received Date</div><div class="v">{{ e.receivedDate or '‚Äî' }}</div></div>
                        <div class="kv"><div class="k">Received Qty</div><div class="v">{{ e.receivedQuantity or '‚Äî' }}</div></div>
                      {% else %}
                        <div class="kv"><div class="k">Processed Date</div><div class="v">{{ e.processedDate or '‚Äî' }}</div></div>
                        <div class="kv"><div class="k">Processed Qty</div><div class="v">{{ e.processedQuantity or '‚Äî' }}</div></div>
                      {% endif %}

                    {% elif e.status == 'Distributed' %}
                      {% if (e.stage or '') == 'Received' %}
                        <div class="kv"><div class="k">Received Date</div><div class="v">{{ e.receivedDate or '‚Äî' }}</div></div>
                        <div class="kv"><div class="k">Received Qty</div><div class="v">{{ e.receivedQuantity or e.quantity or '‚Äî' }}</div></div>
                      {% else %}
                        <div class="kv"><div class="k">Dispatch Date</div><div class="v">{{ e.dispatchDate or e.processedDate or '‚Äî' }}</div></div>
                        <div class="kv"><div class="k">Distributed Qty</div><div class="v">{{ e.distributedQuantity or '‚Äî' }}</div></div>
                      {% endif %}

                    {% elif e.status == 'Retail' %}
                      {% if (e.stage or '') == 'Received' %}
                        <div class="kv"><div class="k">Received Date</div><div class="v">{{ e.receivedDate or '‚Äî' }}</div></div>
                        <div class="kv"><div class="k">Received Qty</div><div class="v">{{ e.receivedQuantity or e.quantity or '‚Äî' }}</div></div>
                      {% else %}
                        <div class="kv"><div class="k">Sold Date</div><div class="v">{{ e.soldDate or '‚Äî' }}</div></div>
                        <div class="kv"><div class="k">Sold Qty</div><div class="v">{{ e.soldQuantity or '‚Äî' }}</div></div>
                      {% endif %}
                    {% endif %}
                  </div>
                </div>
              </article>
            {% endfor %}
          {% else %}
            <article class="event show empty">
              <div class="event-strip">
                <div class="event-strip-left">
                  <span class="event-strip-icon">‚ÑπÔ∏è</span>
                  <div class="event-strip-titles">
                    <div class="event-strip-title">No events found</div>
                    <div class="event-strip-sub"><span class="small">No history available for this crop.</span></div>
                  </div>
                </div>
              </div>

              <div class="event-body">
                <div class="thumb">
                  <img src="{{ placeholder }}" alt="No data">
                  <div class="byline">By ‚Äì ‚Äî</div>
                </div>
                <div class="details">
                  <div class="kv">
                    <div class="k">Message</div>
                    <div class="v">Please track another crop ID.</div>
                  </div>
                </div>
              </div>
            </article>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="side">

      <!-- Product Preview -->
      <div class="side-card product-side-card">
        <div class="side-head">
          <div>
            <div class="side-title">Product Preview</div>
            <div class="side-subtitle">Verified crop snapshot</div>
          </div>
        </div>

        <div class="side-body">
          <div class="product-media">
            <img id="productImg"
                 src="{{ product_image_url or product_img }}"
                 alt="{{ crop_raw }}"
                 loading="eager"
                 crossorigin="anonymous"
                 onerror="this.onerror=null;this.src='{{ placeholder }}'">
            <div class="ribbon">Crop ‚Ä¢ {{ crop_id or '‚Äî' }}</div>
          </div>

          <div class="meta-grid">
            <div class="meta-item">
              <div class="meta-k">Crop Type</div>
              <div class="meta-v">{{ crop_raw }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-k">Latest Status</div>
              <div class="meta-v">{{ events_combined[-1].status if events_combined else '‚Äî' }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-k">Origin</div>
              <div class="meta-v">{{ events_combined[0].location if events_combined else '‚Äî' }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-k">Primary Actor</div>
              <div class="meta-v">{{ events_combined[0].actor if events_combined else '‚Äî' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Nutrition -->
      <div class="side-card">
        <div class="side-head">
          <div>
            <div class="side-title">Nutritional Value</div>
            <div class="side-subtitle">Per 100 g (approx.)</div>
          </div>
        </div>
        <div class="side-body">
          <div class="nutri-grid" id="nutriGrid"></div>
        </div>
      </div>

    </aside>

  </div>

  <footer class="foot">¬© {{ current_year or "" }} Precision Grow Traceability ‚Ä¢ Visual food journeys</footer>
</main>

<script>
  window.__TRACE_CROP__ = "{{ crop_dir }}";
</script>
<script src="{{ url_for('static', filename='js/traceabilityjourney.js') }}"></script>
</body>
</html>
