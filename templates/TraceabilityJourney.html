<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ crop_id }} Â· Traceability Journey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>

<link rel="stylesheet" href="{{ url_for('static', filename='traceabilityjourney.css') }}">
</head>
<body>

  <!-- HERO -->
  <section class="hero">
    <div class="bgfx">
      <svg class="blob float-slow" width="1200" height="380" viewBox="0 0 1200 380" fill="none" style="position:absolute; top:-120px; left:-140px;">
        <defs><linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="var(--brand)" stop-opacity=".55"/>
          <stop offset="100%" stop-color="var(--brand2)" stop-opacity=".45"/>
        </linearGradient></defs>
        <path d="M291 137c71-96 212-145 330-99s190 190 303 222c112 33 241-30 282 32 41 62-43 146-140 168-96 22-205-16-307-8-102 8-197 66-302 56-106-11-223-95-240-198-16-103 3-176 74-173z" fill="url(#g1)"/>
      </svg>
      <svg class="blob float-fast" width="900" height="260" viewBox="0 0 900 260" fill="none" style="position:absolute; bottom:-60px; right:-80px;">
        <defs><linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="var(--brand2)" stop-opacity=".50"/>
          <stop offset="100%" stop-color="var(--brand)" stop-opacity=".35"/>
        </linearGradient></defs>
        <path d="M172 86c42-57 128-86 200-59 72 27 115 114 183 133 68 19 145-18 169 19 24 37-26 96-84 110s-123-10-185-5c-62 5-119 43-183 36-64-7-134-62-144-129S130 143 172 86z" fill="url(#g2)"/>
      </svg>
    </div>

    <div class="shell hero-inner">
      <div>
        <div class="kicker">From Field to Shelf</div>
        <h1 class="h1">{{ (events_combined[0].cropType if events_combined else 'Product') }} Traceability Journey</h1>
        <p class="sub">  Explore the entire lifecycle of your product with real-time blockchain records.  
  Trust the source, validate each handoff, and experience farm-to-fork transparency..</p>
        <div class="hero-badges">
          <span class="tag">ðŸŒ¿ Farm Origin</span>
          <span class="tag">ðŸ§º Processing</span>
          <span class="tag">ðŸšš Logistics</span>
        </div>
      </div>

      <!-- Product highlight -->
      <div class="card" style="max-width:520px; margin-left:auto">
        <div class="photo">
          {% set _type = (events_combined[0].cropType if events_combined and events_combined[0].cropType else '')|lower %}
          {% set fallback_img = '/static/images/crops/' ~ (_type|replace(' ','_')) ~ '.jpg' %}
          <img
            src="{{ product_image_url or fallback_img }}"
            alt="{{ _type or 'product' }}"
            loading="lazy"
            onerror="this.onerror=null;this.src='/static/images/crops/placeholder.jpg'">
          <div class="ribbon">Crop â€¢ {{ crop_id or 'â€”' }}</div>
        </div>
        <div class="card-body">
          <div class="meta">
            <div class="cell"><div class="note">Crop Type</div><div class="big">{{ events_combined[0].cropType if events_combined else 'â€”' }}</div></div>
            <div class="cell"><div class="note">Latest Status</div><div class="big">{{ events_combined[-1].status if events_combined else 'â€”' }}</div></div>
            <div class="cell"><div class="note">Origin</div><div>{{ events_combined[0].location if events_combined else 'â€”' }}</div></div>
            <div class="cell"><div class="note">Actor</div><div>{{ events_combined[0].actor if events_combined else 'â€”' }}</div></div>
          </div>
          <div class="cta">
            <a class="btn ghost" href="/">Home</a>
            <form method="POST" action="/export-pdf/{{ crop_id }}" style="margin:0"><button class="btn" type="submit">Export PDF</button></form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- BODY -->
  <div class="shell" style="padding:22px 18px 40px">
    <div class="grid">

      <!-- LEFT: Timeline -->
      <section class="panel">
        <div class="panel-head">
          <div class="title">Trace Stages</div>
          <div class="muted">End-to-end overview with imagery</div>
        </div>

{# ---- Crop-aware stage images with sub-stages + graceful fallbacks ---- #}
{% set _crop      = (events_combined[0].cropType if events_combined else '')|lower %}
{% set crop_slug  = _crop|replace(' ', '-')|replace('/', '-')|replace('&', 'and') %}
{% set base_dir   = '/static/images/crops/' ~ crop_slug %}
{% set common_dir = '/static/images/crops/_common' %}
{% set placeholder= '/static/images/crops/placeholder.jpg' %}

{# Optional dict overrides from backend: stage_images = {
     'cover': '...', 'planted': '...', 'harvested': '...',
     'processed_received': '...', 'processed_processed': '...',
     'distributed_received': '...', 'distributed_dispatched': '...',
     'retail_received': '...', 'retail_sold': '...'
} #}

{# Cover (hero) #}
{% set cover_img =
  (stage_images.cover if stage_images and stage_images.get('cover')) or
  (base_dir ~ '/cover.jpg')
%}

{# Core stages #}
{% set planted_img =
  (stage_images.planted if stage_images and stage_images.get('planted')) or
  (base_dir ~ '/planted.jpg') or
  (common_dir ~ '/planted.jpg')
%}

{% set harvested_img =
  (stage_images.harvested if stage_images and stage_images.get('harvested')) or
  (base_dir ~ '/harvested.jpg') or
  (common_dir ~ '/harvested.jpg')
%}

{# Processed: Received vs Processed #}
{% set processed_received_img =
  (stage_images.processed_received if stage_images and stage_images.get('processed_received')) or
  (base_dir ~ '/processed_received.jpg') or
  (common_dir ~ '/processed_received.jpg')
%}

{% set processed_processed_img =
  (stage_images.processed_processed if stage_images and stage_images.get('processed_processed')) or
  (base_dir ~ '/processed_processed.jpg') or
  (common_dir ~ '/processed_processed.jpg')
%}

{# Distributed: Received vs Dispatched #}
{% set distributed_received_img =
  (stage_images.distributed_received if stage_images and stage_images.get('distributed_received')) or
  (base_dir ~ '/distributed_received.jpg') or
  (common_dir ~ '/distributed_received.jpg')
%}

{% set distributed_dispatched_img =
  (stage_images.distributed_dispatched if stage_images and stage_images.get('distributed_dispatched')) or
  (base_dir ~ '/distributed_dispatched.jpg') or
  (common_dir ~ '/distributed_dispatched.jpg')
%}

{# Retail: Received vs Sold #}
{% set retail_received_img =
  (stage_images.retail_received if stage_images and stage_images.get('retail_received')) or
  (base_dir ~ '/retail_received.jpg') or
  (common_dir ~ '/retail_received.jpg')
%}

{% set retail_sold_img =
  (stage_images.retail_sold if stage_images and stage_images.get('retail_sold')) or
  (base_dir ~ '/retail_sold.jpg') or
  (common_dir ~ '/retail_sold.jpg')
%}

<div class="timeline">
  <div class="rail">
    {% if events_combined %}
      {% for e in events_combined %}
        {# --------- image selection (crop + stage aware) --------- #}
        {% set key = (e.image_stage or e.status or 'event')|lower %}
        {# Prefer a dict like stage_images = { 'processed_received': '/static/...', ... } if you pass it.
           Otherwise fall back to per-stage single variables; finally to a safe placeholder. #}
        {% set thumb_url = (
          (stage_images.get(key) if stage_images is defined and stage_images) 
          or
          (
            planted_img if key == 'planted' else
            harvested_img if key == 'harvested' else
            processed_received_img if key == 'processed_received' else
            processed_processed_img if key in ['processed','processed_processed'] else
            distributed_received_img if key == 'distributed_received' else
            distributed_dispatched_img if key == 'distributed_dispatched' else
            retail_received_img if key == 'retail_received' else
            retail_sold_img if key == 'retail_sold' else
            (product_image_url or '/static/images/crops/placeholder.jpg')
          )
        ) %}

<article class="event" data-kind="{{ key }}">

  <!-- âœ… Heading above image -->
  <div class="event-heading" style="font-weight:700; font-size:15px; margin-bottom:6px;margin-left: 10px;margin-top: 10px;">
    {{ e.status }}{% if e.stage %} â€¢ {{ e.stage }}{% endif %}
  </div>

  <div class="event-thumb">
    <img src="{{ thumb_url }}"
         alt="{{ e.status }} {{ e.stage or '' }} image"
         loading="lazy"
         onerror="this.onerror=null;this.src='/static/images/crops/placeholder.jpg'">
  </div>

  <div class="event-body">
    <!-- <div class="label">
      <span class="badge">{{ e.status }}{% if e.stage %} â€¢ {{ e.stage }}{% endif %}</span>
      <span>{{ e.timestamp }}</span>
    </div> -->

    <div class="rows">
      <div class="row"><b>Actor:</b> {{ e.actor or 'â€”' }}</div>
      <div class="row"><b>Location:</b> {{ e.location or 'â€”' }}</div>
      <div class="row"><b>Crop Type:</b> {{ e.cropType or 'â€”' }}</div>
      {% if e.batchCode %}
        <div class="row"><b>Batch:</b> {{ e.batchCode }}</div>
      {% endif %}

      {# ---- Per-status details remain unchanged ---- #}
      {% if e.status == 'Planted' %}
        <div class="row"><b>Date Planted:</b> {{ e.datePlanted or 'â€”' }}</div>
        <div class="row"><b>Area Size:</b> {{ e.areaSize or 'â€”' }}</div>

      {% elif e.status == 'Harvested' %}
        <div class="row"><b>Harvest Date:</b> {{ e.harvestDate or 'â€”' }}</div>
        <div class="row"><b>Quantity:</b> {{ e.harvestQuantity or 'â€”' }}</div>
        <div class="row"><b>Packaging:</b> {{ e.packagingType or 'â€”' }}</div>
        {% if e.harvesterName %}
          <div class="row"><b>Harvester:</b> {{ e.harvesterName }}</div>
        {% endif %}

      {% elif e.status == 'Processed' %}
        {% if (e.stage or '') == 'Received' %}
          <div class="row"><b>Received Date:</b> {{ e.receivedDate or 'â€”' }}</div>
          <div class="row"><b>Received Qty:</b> {{ e.receivedQuantity or 'â€”' }}</div>
        {% else %}
          <div class="row"><b>Processed Date:</b> {{ e.processedDate or 'â€”' }}</div>
          <div class="row"><b>Processed Qty:</b> {{ e.processedQuantity or 'â€”' }}</div>
        {% endif %}

      {% elif e.status == 'Distributed' %}
        {% if (e.stage or '') == 'Received' %}
          <div class="row"><b>Received Date:</b> {{ e.receivedDate or 'â€”' }}</div>
          <div class="row"><b>Received Qty:</b> {{ e.receivedQuantity or e.quantity or 'â€”' }}</div>
        {% else %}
          <div class="row"><b>Dispatch Date:</b> {{ e.dispatchDate or e.processedDate or 'â€”' }}</div>
          <div class="row"><b>Distributed Qty:</b> {{ e.distributedQuantity or 'â€”' }}</div>
        {% endif %}

      {% elif e.status == 'Retail' %}
        {% if (e.stage or '') == 'Received' %}
          <div class="row"><b>Received Date:</b> {{ e.receivedDate or 'â€”' }}</div>
          <div class="row"><b>Received Qty:</b> {{ e.receivedQuantity or e.quantity or 'â€”' }}</div>
        {% else %}
          <div class="row"><b>Sold Date:</b> {{ e.soldDate or 'â€”' }}</div>
          <div class="row"><b>Sold Qty:</b> {{ e.soldQuantity or 'â€”' }}</div>
        {% endif %}

      {% else %}
        {% if e.note %}
          <div class="row"><b>Note:</b> {{ e.note }}</div>
        {% endif %}
      {% endif %}
    </div>
  </div>
</article>

      {% endfor %}
    {% else %}
      <article class="event show">
        <div class="event-thumb">
          <img src="/static/images/crops/placeholder.jpg" alt="No data">
        </div>
        <div class="event-body">
          <div class="label"><span class="badge">No events</span> â€”</div>
          <div class="rows"><div class="row">No history available for this crop.</div></div>
        </div>
      </article>
    {% endif %}
  </div>
</div>

      </section>

      <!-- RIGHT: Nutrition -->
      <aside class="card">
        <div class="panel-head" style="border:none">
          <div>
            <div class="title">Nutritional Value</div>
            <div class="muted">Per 100 g (approx.)</div>
          </div>
        </div>
        <div class="card-body">
          <div class="nutri-grid" id="nutriGrid"></div>
          <div class="cta" style="margin-top:14px">
            <a class="btn ghost" href="/track">Track Another</a>
            <a class="btn ghost" href="/">Back Home</a>
          </div>
        </div>
      </aside>

    </div>

    <div class="foot">Â© {{ current_year or "" }} Precision Grow Traceability â€¢ Visual food journeys</div>
  </div>

<script src="{{ url_for('static', filename='js/traceabilityjourney.js') }}"></script>
</body>
</html>
