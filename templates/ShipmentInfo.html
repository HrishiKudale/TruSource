{% extends "farmer_base.html" %}
{% set current_page = "logistics" %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='shipmentinfo.css') }}">

{% set sd = (request.shipment_details[0] if request and request.shipment_details and request.shipment_details|length else {}) %}
{% set td = (request.transporter_details[0] if request and request.transporter_details and request.transporter_details|length else {}) %}
{% set pd = (request.payment_details[0] if request and request.payment_details and request.payment_details|length else {}) %}
{% set items = (request.shipment_items if request and request.shipment_items else []) %}

<div class="shipmentinfo-container">

  <!-- Back + Title Row -->
  <div class="shipmentinfo-header">
    <a href="{{ url_for('farmer_logistics.list_shipments') }}" class="back-btn" style="width:34px;height:34px;">
      <img src="{{ url_for('static', filename='svg-icons/BackAddCrop.svg') }}" alt="Back">
    </a>

    <img src="{{ url_for('static', filename='svg-icons/CaretRightProperty 1=Regular.svg') }}" alt=">">

    <h1 class="shipment-title">Request {{ request._id if request else '-' }}</h1>

    <span class="status-pill status-pending">
      {{ request.status if request and request.status else 'pending' }}
    </span>

    <div class="header-actions">
      <button class="export-btn" type="button" id="btnCopyReq">
        Copy ID
      </button>
      <button class="archive-btn" type="button">
        Export
      </button>
    </div>
  </div>


  <div class="shipmentinfo-layout">

    <!-- LEFT COLUMN -->
    <div class="left-col">

      <!-- Row 1: Card1 + Card2 (1:3) -->
      <div class="top-row">

        <!-- CARD 1: Shipment Details (small) -->
        <div class="card card-small">
          <div class="card-header">
            <img src="{{ url_for('static', filename='svg-icons/Logistics/ShipmentInfoDetails.svg') }}" class="card-icon" alt="">
            <h2 class="section-title">Shipment Details</h2>
          </div>

          <div class="card-body">
            <div class="info-block">
              <p class="label">Request ID</p>
              <p class="value" id="reqIdText">{{ request._id if request else '-' }}</p>
            </div>

            <div class="info-block">
              <p class="label">Created On</p>
              <p class="value">
                {% if request and request.created_at %}
                  {{ request.created_at }}
                {% else %}
                  -
                {% endif %}
              </p>
            </div>

            <div class="info-block">
              <p class="label">Transporter Type</p>
              <p class="value">
                {% if td and td.transporter_mode %}
                  {{ td.transporter_mode }}
                {% else %}
                  -
                {% endif %}
              </p>
            </div>
          </div>
        </div>

        <!-- CARD 2: Transporter & Vehicle Details (large) -->
        <div class="card card-large">
          <div class="card-header">
            <img src="{{ url_for('static', filename='svg-icons/Logistics/ShipmentInfoTransporter.svg') }}" class="card-icon" alt="">
            <h2 class="section-title">Transporter &amp; Vehicle Details</h2>
          </div>

          <div class="card-body">

            {% if charges %}
              <div class="details-grid-2">
                <div class="detail-item">
                  <p class="label">Transporter Name</p>
                  <p class="value">{{ charges.transporter_name or td.transporter_name or '-' }}</p>
                </div>

                <div class="detail-item">
                  <p class="label">Driver Name</p>
                  <p class="value">{{ charges.driver_name or '-' }}</p>
                </div>

                <div class="detail-item">
                  <p class="label">Vehicle No</p>
                  <p class="value">{{ charges.vehicle_no or '-' }}</p>
                </div>

                <div class="detail-item">
                  <p class="label">Vehicle Type</p>
                  <p class="value">{{ charges.vehicle_type or td.vehicle_type or '-' }}</p>
                </div>

                <div class="detail-item">
                  <p class="label">Driver Phone</p>
                  <p class="value">{{ charges.driver_phone or '-' }}</p>
                </div>
              </div>
            {% else %}
              <div class="empty-illustration">
                <img src="{{ url_for('static', filename='illustrations/Transporter & Vehicle Details.svg') }}" alt="">
                <h3 class="empty-title">No Transporter Charges Yet</h3>
                <p class="empty-text">Transporter &amp; vehicle details will appear once charges are generated.</p>
              </div>
            {% endif %}

          </div>
        </div>

      </div>


      <!-- Row 2: Card3 + Card4 (1:1) -->
      <div class="mid-row">

        <!-- CARD 3: Pickup Details -->
        <div class="card">
          <div class="card-header">
            <img src="{{ url_for('static', filename='svg-icons/Logistics/ShipmentInfoPickup.svg') }}" class="card-icon" alt="">
            <h2 class="section-title">Pickup Details</h2>
          </div>

          <div class="card-body">
            <div class="details-grid-2">
              <div class="detail-item full">
                <p class="label">Pickup From</p>
                <p class="value">{{ sd.pickup_from or '-' }}</p>
              </div>

              <div class="detail-item full">
                <p class="label">Pickup Location</p>
                <p class="value">{{ sd.pickup_location or '-' }}</p>
              </div>

              <div class="detail-item">
                <p class="label">Warehouse ID</p>
                <p class="value">{{ sd.pickup_id or '-' }}</p>
              </div>

              <div class="detail-item">
                <p class="label">Batch ID</p>
                <p class="value">{{ request.batch_id if request and request.batch_id else '-' }}</p>
              </div>

              <div class="detail-item">
                <p class="label">Pickup Date</p>
                <p class="value">{{ td.pickup_date or '-' }}</p>
              </div>

              <div class="detail-item">
                <p class="label">Actual Pickup Date</p>
                <p class="value">{{ request.actual_pickup_date if request and request.actual_pickup_date else '-' }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- CARD 4: Drop Location -->
        <div class="card">
          <div class="card-header">
            <img src="{{ url_for('static', filename='svg-icons/Logistics/ShipmentInfoDrop.svg') }}" class="card-icon" alt="">
            <h2 class="section-title">Drop Location</h2>
          </div>

          <div class="card-body">
            <div class="details-grid-2">
              <div class="detail-item full">
                <p class="label">Deliver To</p>
                <p class="value">{{ sd.deliver_to or '-' }}</p>
              </div>

              <div class="detail-item full">
                <p class="label">Delivery Address</p>
                <p class="value">
                  {% if buyer_user %}
                    {{ buyer_user.officeAddress or buyer_user.location or sd.deliver_location or '-' }}
                  {% else %}
                    {{ sd.deliver_location or '-' }}
                  {% endif %}
                </p>
              </div>

              <div class="detail-item full">
                <p class="label">Buyer Type</p>
                <p class="value">
                  {% if buyer_user and buyer_user.role %}
                    {{ buyer_user.role }}
                  {% else %}
                    -
                  {% endif %}
                </p>
              </div>

              <div class="detail-item">
                <p class="label">Expected Delivery</p>
                <p class="value">{{ td.delivery_date or '-' }}</p>
              </div>

              <div class="detail-item">
                <p class="label">Actual Delivery Date</p>
                <p class="value">{{ request.actual_delivery_date if request and request.actual_delivery_date else '-' }}</p>
              </div>
            </div>
          </div>
        </div>

      </div>


      <!-- CARD 5: Payment Details -->
      <div class="card">
        <div class="card-header">
          <img src="{{ url_for('static', filename='svg-icons/Logistics/ShipmentInfoPayment.svg') }}" class="card-icon" alt="">
          <h2 class="section-title">Payment Details</h2>
        </div>

        <div class="card-body">
          {% if request and request.payment_details and request.payment_details|length %}
            <div class="details-grid-2">
              <div class="detail-item">
                <p class="label">Payment ID</p>
                <p class="value">{{ request.payment_id if request and request.payment_id else '-' }}</p>
              </div>

              <div class="detail-item">
                <p class="label">Payment Mode</p>
                <p class="value">{{ pd.payment_terms or '-' }}</p>
              </div>

              <div class="detail-item">
                <p class="label">Due Date</p>
                <p class="value">{{ request.due_date if request and request.due_date else '-' }}</p>
              </div>

              <div class="detail-item">
                <p class="label">Invoice Amount</p>
                <p class="value">{{ request.invoice_amount if request and request.invoice_amount else '-' }}</p>
              </div>
            </div>
          {% else %}
            <div class="empty-illustration">
              <img src="{{ url_for('static', filename='illustrations/Empty Transport Table.svg') }}" alt="">
              <h3 class="empty-title">No Payment Data Yet</h3>
              <p class="empty-text">Payment details will appear when an invoice is generated.</p>
            </div>
          {% endif %}
        </div>
      </div>


      <!-- CARD 6: Document List -->
      <div class="card">
        <div class="card-header">
          <img src="{{ url_for('static', filename='svg-icons/Logistics/ShipmentInfoDoc.svg') }}" class="card-icon" alt=""
               onerror="this.style.display='none'">
          <h2 class="section-title">Document List</h2>
        </div>

        <div class="card-body">

          <div class="doc-grid">
            <div class="doc-table">
              <div class="doc-row doc-head">
                <span>Name</span><span>Status</span>
              </div>

              {% set docs1 = (request.documents_left if request and request.documents_left else []) %}
              {% if docs1|length %}
                {% for d in docs1 %}
                <div class="doc-row">
                  <span class="doc-name">{{ d.name or '-' }}</span>
                  <span class="doc-status {{ 'ok' if (d.status or '')|lower=='verified' else 'pending' }}">
                    {{ d.status or 'Pending' }}
                  </span>
                </div>
                {% endfor %}
              {% else %}
                <div class="doc-row">
                  <span class="doc-name">Invoice</span>
                  <span class="doc-status pending">Pending</span>
                </div>
                <div class="doc-row">
                  <span class="doc-name">LR Copy</span>
                  <span class="doc-status pending">Pending</span>
                </div>
              {% endif %}
            </div>

            <div class="doc-table">
              <div class="doc-row doc-head">
                <span>Name</span><span>Status</span>
              </div>

              {% set docs2 = (request.documents_right if request and request.documents_right else []) %}
              {% if docs2|length %}
                {% for d in docs2 %}
                <div class="doc-row">
                  <span class="doc-name">{{ d.name or '-' }}</span>
                  <span class="doc-status {{ 'ok' if (d.status or '')|lower=='verified' else 'pending' }}">
                    {{ d.status or 'Pending' }}
                  </span>
                </div>
                {% endfor %}
              {% else %}
                <div class="doc-row">
                  <span class="doc-name">E-Way Bill</span>
                  <span class="doc-status pending">Pending</span>
                </div>
                <div class="doc-row">
                  <span class="doc-name">POD</span>
                  <span class="doc-status pending">Pending</span>
                </div>
              {% endif %}
            </div>
          </div>

        </div>
      </div>


      <!-- CARD 7: Linked Orders -->
      <div class="card">
        <div class="card-header">
          <img src="{{ url_for('static', filename='svg-icons/Logistics/ShipInfoLinkedOrder.svg') }}" class="card-icon" alt="">
          <h2 class="section-title">Linked Orders</h2>
        </div>

        <div class="card-body">

          <div class="table-tools">
            <div class="search-mini">
              <img src="{{ url_for('static', filename='svg-icons/MagnifyingGlass.svg') }}" alt="">
              <input id="linkedOrdersSearch" type="search" placeholder="Search orders...">
            </div>
          </div>

          <div class="table-wrap">
            <table class="linked-table" id="linkedOrdersTable">
              <thead>
                <tr>
                  <th>OrderID</th>
                  <th>OrderDate</th>
                  <th>CropName</th>
                  <th>Quantity</th>
                </tr>
              </thead>
              <tbody>
                {% if items|length %}
                  {% for it in items %}
                  <tr>
                    <td>{{ it.order_id or '-' }}</td>
                    <td>{{ it.order_date or '-' }}</td>
                    <td>{{ it.crop_name or it.crop_id or '-' }}</td>
                    <td>{{ it.quantity or '-' }}</td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr class="no-data-row">
                    <td colspan="4" style="text-align:center; padding:16px;">No linked orders found.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

        </div>
      </div>

    </div>


    <!-- RIGHT COLUMN (same style as CropInfo “activity card”) -->
    <div class="right-col">

      <div class="card activity-card">
        <div class="card-body">
          <div class="activity-card-row">
            <img src="{{ url_for('static', filename='svg-icons/Crop Registered.svg') }}"
                 class="activity-illustration" alt="">

            <div class="activity-texts">
              <h3 class="activity-title">Shipment Created</h3>
              <p class="activity-text">
                This shipment request is currently
                <strong>{{ request.status if request and request.status else 'pending' }}</strong>.
              </p>
              <p class="activity-date">
                {% if request and request.created_at %}{{ request.created_at }}{% else %}-{% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<script src="{{ url_for('static', filename='js/shipmentinfo.js') }}"></script>
{% endblock %}
